name: PR Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: '3.10'

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install flake8 black isort pytest pytest-cov

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Check if PR title follows conventional commits
          if echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?: .+'; then
            echo "âœ… PR title follows conventional commits format"
          else
            echo "âŒ PR title should follow conventional commits format:"
            echo "   feat: add new feature"
            echo "   fix: fix bug"
            echo "   docs: update documentation"
            echo "   etc."
            exit 1
          fi

      - name: Check file size limits
        run: |
          # Check for files larger than 10MB
          LARGE_FILES=$(find . -type f -size +10M -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./.venv/*")

          if [ -n "$LARGE_FILES" ]; then
            echo "âŒ Found files larger than 10MB:"
            echo "$LARGE_FILES"
            exit 1
          else
            echo "âœ… No large files found"
          fi

      - name: Check for secrets
        run: |
          # Simple check for common secret patterns
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE '(api[_-]?key|password|secret|token|aws[_-]?access).*=.*[A-Za-z0-9+/]{20,}'; then
            echo "âš ï¸ Possible secrets detected in diff!"
            echo "Please review the changes and ensure no secrets are committed"
            exit 1
          else
            echo "âœ… No obvious secrets detected"
          fi

      - name: Lint changed Python files
        run: |
          # Get list of changed Python files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.py$' || true)

          if [ -n "$CHANGED_FILES" ]; then
            echo "Linting changed files:"
            echo "$CHANGED_FILES"

            echo "$CHANGED_FILES" | xargs flake8 --max-line-length=120 --extend-ignore=E203,W503
            echo "âœ… Flake8 passed"

            echo "$CHANGED_FILES" | xargs black --check --line-length=120
            echo "âœ… Black formatting passed"

            echo "$CHANGED_FILES" | xargs isort --check-only
            echo "âœ… Import sorting passed"
          else
            echo "No Python files changed"
          fi

      - name: Run affected tests
        run: |
          # Determine which services were changed
          CHANGED_SERVICES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^services/' | cut -d'/' -f2 | sort -u)

          if [ -n "$CHANGED_SERVICES" ]; then
            echo "Running tests for changed services:"
            for SERVICE in $CHANGED_SERVICES; do
              echo "Testing $SERVICE..."
              if [ -d "services/$SERVICE/tests" ]; then
                cd services/$SERVICE
                pip install -r requirements.txt
                pytest tests/ -v --cov=app
                cd ../..
              else
                echo "No tests found for $SERVICE"
              fi
            done
          else
            echo "No service changes detected"
          fi

      - name: Check Docker builds
        run: |
          # Check if Dockerfile changed
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q 'Dockerfile'; then
            echo "Dockerfile changed, testing build..."

            if [ -f "services/inference-service/Dockerfile" ]; then
              docker build -f services/inference-service/Dockerfile -t test:latest .
              echo "âœ… Docker build successful"
            fi
          else
            echo "No Dockerfile changes"
          fi

      - name: Estimate deployment size
        run: |
          echo "ðŸ“Š Estimated Deployment Sizes:"

          # Estimate Lambda package sizes
          for SERVICE in feedback-service model-service evaluation-service; do
            if [ -d "services/$SERVICE" ]; then
              SIZE=$(du -sh services/$SERVICE | cut -f1)
              echo "  $SERVICE: $SIZE"
            fi
          done

          # Estimate Docker image size
          if [ -f "services/inference-service/Dockerfile" ]; then
            echo "  inference-service (Docker): Building to estimate..."
            docker build -f services/inference-service/Dockerfile -t size-test:latest . -q
            SIZE=$(docker images size-test:latest --format "{{.Size}}")
            echo "  inference-service: $SIZE"
          fi

      - name: PR validation summary
        if: success()
        run: |
          echo "âœ… All PR validation checks passed!"
          echo ""
          echo "ðŸ“ Summary:"
          echo "  - PR title format: âœ…"
          echo "  - File sizes: âœ…"
          echo "  - No secrets: âœ…"
          echo "  - Code quality: âœ…"
          echo "  - Tests: âœ…"
          echo ""
          echo "Ready for review! ðŸš€"

  label-pr:
    name: Auto-label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Label based on size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const additions = files.reduce((sum, file) => sum + file.additions, 0);
            const deletions = files.reduce((sum, file) => sum + file.deletions, 0);
            const changes = additions + deletions;

            let sizeLabel = 'size/XS';
            if (changes > 500) sizeLabel = 'size/XL';
            else if (changes > 250) sizeLabel = 'size/L';
            else if (changes > 100) sizeLabel = 'size/M';
            else if (changes > 30) sizeLabel = 'size/S';

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel]
            });

      - name: Label based on files changed
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = new Set();

            files.forEach(file => {
              if (file.filename.includes('services/feedback-service')) labels.add('service:feedback');
              if (file.filename.includes('services/model-service')) labels.add('service:model');
              if (file.filename.includes('services/evaluation-service')) labels.add('service:evaluation');
              if (file.filename.includes('services/inference-service')) labels.add('service:inference');
              if (file.filename.includes('services/api-gateway/static')) labels.add('component:web');
              if (file.filename.includes('.github/workflows')) labels.add('component:ci-cd');
              if (file.filename.endsWith('.md')) labels.add('documentation');
              if (file.filename.includes('test')) labels.add('tests');
            });

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels)
              });
            }
