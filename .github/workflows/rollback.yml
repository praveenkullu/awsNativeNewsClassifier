name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to rollback'
        required: true
        type: choice
        options:
          - all
          - lambda-feedback
          - lambda-model
          - lambda-evaluation
          - ecs-inference
      version:
        description: 'Version to rollback to (leave empty for previous)'
        required: false
        type: string

env:
  AWS_REGION: us-east-2

jobs:
  rollback:
    name: Rollback ${{ inputs.service }}
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Confirm rollback
        run: |
          echo "‚ö†Ô∏è  ROLLBACK INITIATED"
          echo "Service: ${{ inputs.service }}"
          echo "Target Version: ${{ inputs.version || 'previous' }}"
          echo ""
          echo "This will rollback the deployment. Waiting 10 seconds..."
          sleep 10

      - name: Rollback Lambda - Feedback
        if: inputs.service == 'all' || inputs.service == 'lambda-feedback'
        run: |
          FUNCTION_NAME="ml-news-feedback"

          if [ -z "${{ inputs.version }}" ]; then
            # Get previous version
            VERSION=$(aws lambda list-versions-by-function \
              --function-name $FUNCTION_NAME \
              --region ${{ env.AWS_REGION }} \
              --query 'Versions[-2].Version' \
              --output text)
          else
            VERSION="${{ inputs.version }}"
          fi

          echo "Rolling back $FUNCTION_NAME to version $VERSION"

          aws lambda update-alias \
            --function-name $FUNCTION_NAME \
            --name live \
            --function-version $VERSION \
            --region ${{ env.AWS_REGION }} || true

          # Update function configuration to use specific version
          aws lambda update-function-configuration \
            --function-name $FUNCTION_NAME \
            --environment Variables={FUNCTION_VERSION=$VERSION} \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Rolled back $FUNCTION_NAME to version $VERSION"

      - name: Rollback Lambda - Model
        if: inputs.service == 'all' || inputs.service == 'lambda-model'
        run: |
          FUNCTION_NAME="ml-news-model"

          if [ -z "${{ inputs.version }}" ]; then
            VERSION=$(aws lambda list-versions-by-function \
              --function-name $FUNCTION_NAME \
              --region ${{ env.AWS_REGION }} \
              --query 'Versions[-2].Version' \
              --output text)
          else
            VERSION="${{ inputs.version }}"
          fi

          echo "Rolling back $FUNCTION_NAME to version $VERSION"

          aws lambda update-alias \
            --function-name $FUNCTION_NAME \
            --name live \
            --function-version $VERSION \
            --region ${{ env.AWS_REGION }} || true

          aws lambda update-function-configuration \
            --function-name $FUNCTION_NAME \
            --environment Variables={FUNCTION_VERSION=$VERSION} \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Rolled back $FUNCTION_NAME to version $VERSION"

      - name: Rollback Lambda - Evaluation
        if: inputs.service == 'all' || inputs.service == 'lambda-evaluation'
        run: |
          FUNCTION_NAME="ml-news-evaluation"

          if [ -z "${{ inputs.version }}" ]; then
            VERSION=$(aws lambda list-versions-by-function \
              --function-name $FUNCTION_NAME \
              --region ${{ env.AWS_REGION }} \
              --query 'Versions[-2].Version' \
              --output text)
          else
            VERSION="${{ inputs.version }}"
          fi

          echo "Rolling back $FUNCTION_NAME to version $VERSION"

          aws lambda update-alias \
            --function-name $FUNCTION_NAME \
            --name live \
            --function-version $VERSION \
            --region ${{ env.AWS_REGION }} || true

          aws lambda update-function-configuration \
            --function-name $FUNCTION_NAME \
            --environment Variables={FUNCTION_VERSION=$VERSION} \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Rolled back $FUNCTION_NAME to version $VERSION"

      - name: Rollback ECS Service
        if: inputs.service == 'all' || inputs.service == 'ecs-inference'
        run: |
          CLUSTER="ml-news-cluster"
          SERVICE="ml-news-inference-service"
          TASK_FAMILY="ml-news-inference"

          # Get current task definition revision
          CURRENT_REVISION=$(aws ecs describe-services \
            --cluster $CLUSTER \
            --services $SERVICE \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].taskDefinition' \
            --output text | grep -oP '(?<=:)\d+$')

          echo "Current task definition revision: $CURRENT_REVISION"

          if [ -z "${{ inputs.version }}" ]; then
            # Rollback to previous revision
            ROLLBACK_REVISION=$((CURRENT_REVISION - 1))
          else
            ROLLBACK_REVISION="${{ inputs.version }}"
          fi

          echo "Rolling back ECS service to revision $ROLLBACK_REVISION"

          aws ecs update-service \
            --cluster $CLUSTER \
            --service $SERVICE \
            --task-definition ${TASK_FAMILY}:${ROLLBACK_REVISION} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "Waiting for service to stabilize..."

          aws ecs wait services-stable \
            --cluster $CLUSTER \
            --services $SERVICE \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Rolled back ECS service to task definition revision $ROLLBACK_REVISION"

      - name: Verify rollback
        run: |
          echo "Verifying rollback..."
          sleep 10

          # Test health endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            ${{ secrets.API_GATEWAY_URL }}/health)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" == "200" ]; then
            echo "‚úÖ Health check passed after rollback"
          else
            echo "‚ö†Ô∏è Health check returned HTTP $HTTP_CODE"
          fi

          echo "Response: $BODY"

      - name: Rollback summary
        if: always()
        run: |
          echo "üìù Rollback Summary"
          echo "Service: ${{ inputs.service }}"
          echo "Target Version: ${{ inputs.version || 'previous' }}"
          echo ""
          echo "‚úÖ Rollback completed"
          echo "üîó API Gateway: ${{ secrets.API_GATEWAY_URL }}"
          echo ""
          echo "‚ö†Ô∏è  Please verify application functionality manually"
